---
title: 
date: 2024-02-23 19:53
tags: 
mathjax: "true"
banner: /images/thumbs/
excerpt:
---

## I$^2$C

I$^2$C 是一种同步、半双工的通信协议，带有一个应答位 `ACK` 。一般使用 I2C 的设备有四个引脚，VCC, GND, SCL（时钟同步）, SDA（数据传输）。

使用 I2C 时，所有设备的 SCL，SDA 都要相连，均配置为开漏输出。I2C 支持一主多从、多主多从，下面只使用一主多从。

> 开漏输出：没有驱动能力的上拉输出。总线上只要有一个设备拉低，则总线变低（线与），可以利用这一特性进行输入。

I2C 是高位先行。

### 基本单元

一个时序单元由起始位、8 位数据、应答位、结束位组成。SDA，SCL 默认为高电平。

无论主机或从机，发送方均在 SCL 为低时根据数据调整 SDA，接收方均在 SCL 为高时读取 SDA。读取过程中，SDA 不允许变化。如果发生变化，认为是起始位或终止位。
![](I2C_img_1.png)
![](I2C_img_2.png)
主机接收数据时，需要将 SDA 置 1，让从机控制 SDA。
![](I2C_img_3.png)


在接收或发送完一个字节后，接收方在下一位发送一位数据，0 表示应答，1 表示非应答。在主机接收数据时，如果回复 0，从机会继续发送数据；回复 1，从机停止发送数据。
![](I2C_img_4.png)

### 读写格式

> 以下将进行一次读写操作发送的一系列数据称为一个数据包。不知道叫什么比较合适，也许叫做时序？

开始发送一个数据包时，发送起始位；数据包结束后，发送终止位。

每个数据包开头由 `Slave Address+R/W` `Reg Address/Control Word` 组成。

I2C 可以在一条总线上挂在多个设备，每个设备有独特的地址。
在读写操作前，数据的第一位是需要操作的设备的地址。

该字节由 7 位地址 +1 位读写位组成，为 1 代表读，0 代表写。
对于 MPU6050，随后是需要读写的寄存器地址。

数据包之后的内容由读写的不同而定。

#### 指定地址写

发送需要写入的数据。对于 MPU6050，内部有一个存储地址指针的寄存器，由 `Reg Address` 指定。每写入一次，该指针就会自增 1，使第二次写入的数据存储到 `Reg Address+1` 的位置。
![](I2C_img_5.png)
<p style="font-size: 13px" align = "center">图中RA即置0的ACK</p>

#### 指定地址读

再发送一次 `起始位+Slave Address+R/W` ，随后主机放开 SDA(SDA 置 1)，开始读取；主机需要停止读取时，ACK 回应 1，读取结束。这一过程中，每读取一位，MPU6050 内部的地址寄存器会自增一，保证读取的数据是从 `Reg Address` 开始连续的一段数据。
![](I2C_img_6.png)
<p style="font-size: 13px" align = "center">图中SA即置1的ACK</p>
>还有`当前地址读`，在发送`Slave Address+R`后直接读取，即得到地址寄存器当前所指位置的寄存器的值。应用不多。

## MPU6050

MPU6050 是六轴传感器，可测量 XYZ 轴加速度、三轴角速度、温度。
TBD

## 代码实现

I2C 的协议较简单，可以通过使用普通的 GPIO 口手动翻转电平来实现。也可以使用 I2C 的硬件外设。stm32 提供2个 I2C 的外设。

### 软件模拟
TBD